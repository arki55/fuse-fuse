name: Nightly build
run-name: Automated nightly build and pre-release

# Executed every night (1 AM) + button
on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  # Merge master from defined repo (usually official fuse repo)
  catchup:
    runs-on: ubuntu-latest
    steps:
      - name: "Merge foreign master"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - run: |
          git fetch --prune
          git remote add repo https://git.code.sf.net/p/fuse-emulator/fuse
          git fetch repo
          git merge repo/master
          git push

  # Build and release nightly prerelease version from master (no draft)
  master:
    needs: [catchup]
    name: "Nightly build from master"
    uses: ./.github/workflows/test_release.yml
    with:
      reason: "Nightly master build"
      draft: false
      generateReleaseNotes: true
      libspectrum_branch: "master"
    secrets:
      RELEASE_TOKEN: "${{ secrets.RELEASE_TOKEN }}"
